<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pastillero Semanal Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Colores pastel para botones y elementos específicos */
        .bg-pastel-blue { background-color: #a7c7e7; }
        .bg-pastel-green { background-color: #98d8c2; }
        .bg-pastel-pink { background-color: #f8c8dc; }
        .bg-pastel-yellow { background-color: #fdfd96; }
        .text-pastel-blue { color: #a7c7e7; }
        .text-pastel-green { color: #98d8c2; }
        .text-pastel-pink { color: #f8c8dc; }
        .text-pastel-yellow { color: #fdfd96; }

        /* Burbujas de días */
        .day-bubble {
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #d1d5db; /* Borde ligero para definición */
        }
        .day-bubble.taken {
            background-color: #6ee7b7; /* Verde menta */
            color: #047857; /* Verde oscuro */
            transform: scale(1.05);
            border-color: #059669; /* Borde más oscuro al marcar */
        }
        .day-bubble:not(.taken) {
            background-color: #e5e7eb; /* Gris claro */
            color: #4b5563; /* Gris oscuro */
        }
        /* Estilos del modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        /* Estilo para botones deshabilitados */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Estilos para etiquetas de prioridad */
        .priority-badge {
            font-size: 0.75rem; /* 12px */
            padding: 0.125rem 0.5rem; /* py-0.5 px-2 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 600; /* font-semibold */
            margin-left: 0.5rem; /* ml-2 */
            vertical-align: middle; /* Alinear con el texto */
        }
        .priority-alta { background-color: #fecaca; color: #991b1b; } /* bg-red-200 text-red-800 */
        .priority-media { background-color: #fef08a; color: #854d0e; } /* bg-yellow-200 text-yellow-800 */
        .priority-baja { background-color: #a7f3d0; color: #065f46; } /* bg-green-200 text-green-800 */

        /* Estilo para observaciones */
        .observations-text {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
            margin-top: 0.25rem; /* mt-1 */
            font-style: italic;
        }
        /* Estilo para encabezados de Grupo de Tomas */
        .take-group-header {
            background-color: #dbeafe; /* bg-blue-100 */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            margin-top: 1.5rem; /* my-6 -> solo margen superior */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #1e3a8a; /* text-blue-800 */
        }

        /* --- ESTILOS PARA IMPRESIÓN --- */
        @media print {
            body {
                background: none !important; /* Fondo blanco para imprimir */
                padding: 0;
                margin: 1cm; /* Margen de impresión */
                font-family: sans-serif; /* Fuente simple */
                color: #000 !important; /* Texto negro */
            }
            /* Ocultar elementos no deseados */
            header,
            section.mb-8, /* Formulario Añadir Med */
            #print-button, /* Botón/Icono de Imprimir */
            .modal,
            .actionsDiv /* Botones Editar/Eliminar en tarjetas */
             {
                display: none !important;
            }
            /* Ajustar contenedor principal */
            .container {
                box-shadow: none !important;
                border: none !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                background: none !important;
            }
            /* Estilo de encabezados de grupo para impresión */
            .take-group-header {
                background-color: #eee !important; /* Gris claro */
                color: #000 !important; /* Texto negro */
                margin-top: 1rem;
                padding: 0.25rem 0.5rem;
                border: 1px solid #ccc;
                page-break-before: auto;
                page-break-after: avoid; /* Evitar salto justo después */
            }
            /* Estilo de tarjetas de medicamento para impresión */
            #med-list > div:not(#no-meds-message) { /* Seleccionar solo las tarjetas */
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important; /* Espacio entre tarjetas */
                page-break-inside: avoid; /* Intentar no cortar tarjetas */
                background: #fff !important; /* Fondo blanco */
            }
             /* Estilo de burbujas de día para impresión */
            .day-bubble {
                border: 1px solid #999 !important;
                width: 1.5rem !important;
                height: 1.5rem !important;
                font-size: 0.7rem !important;
                line-height: 1.4rem !important; /* Ajustar línea vertical */
                margin: 1px !important;
                padding: 0 !important;
            }
            .day-bubble.taken {
                background-color: #ccc !important; /* Gris para tomado */
                color: #000 !important;
                border-color: #666 !important;
                transform: none !important;
            }
            .day-bubble:not(.taken) {
                background-color: #fff !important; /* Blanco para no tomado */
                color: #333 !important;
            }
             /* Simplificar etiquetas de prioridad */
            .priority-badge {
                border: 1px solid #555;
                padding: 0 0.3rem;
                margin-left: 0.3rem;
                background-color: #fff !important; /* Sin fondo */
                font-size: 0.7rem;
            }
            .priority-alta { border-color: #000; color: #000 !important; font-weight: bold;} /* Negro y negrita */
            .priority-media { border-color: #555; color: #000 !important; } /* Gris oscuro */
            .priority-baja { border-color: #999; color: #333 !important; } /* Gris claro */

            /* Asegurar texto negro en elementos generales */
            h1, h2, h3, h4, p, span, div, label, input, select, textarea {
               color: #000 !important;
            }
            /* Ocultar placeholders en impresión si es necesario */
            input::placeholder, textarea::placeholder {
                color: transparent !important;
            }
        }

    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-100 via-pink-50 to-yellow-50 min-h-screen p-4 md:p-8">

    <div class="container mx-auto max-w-4xl bg-white rounded-xl shadow-lg p-6 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Pastillero Semanal Virtual</h1>
            <p class="text-gray-500 mt-2">Organiza y sigue tus medicamentos fácilmente.</p>
        </header>

        <section class="mb-8 p-6 bg-blue-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Añadir Nuevo Medicamento</h2>
            <form id="add-med-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                <div>
                    <label for="med-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="med-name" name="med-name" required placeholder="Ej: Ibuprofeno" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div>
                    <label for="med-dosage" class="block text-sm font-medium text-gray-600 mb-1">Dosis</label>
                    <input type="text" id="med-dosage" name="med-dosage" placeholder="Ej: 400mg, 1 comp." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="med-take-group" class="block text-sm font-medium text-gray-600 mb-1">Grupo de Tomas</label>
                    <input type="text" id="med-take-group" name="med-take-group" placeholder="Ej: A, B, Mañana..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="med-schedule" class="block text-sm font-medium text-gray-600 mb-1">Horario(s) Específico(s)</label>
                    <input type="text" id="med-schedule" name="med-schedule" required placeholder="Ej: 8:00 AM, 9:00 PM" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div>
                    <label for="med-priority" class="block text-sm font-medium text-gray-600 mb-1">Prioridad</label>
                    <select id="med-priority" name="med-priority" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out bg-white">
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                <div class="md:col-span-3">
                     <label for="med-observations" class="block text-sm font-medium text-gray-600 mb-1">Observaciones</label>
                     <textarea id="med-observations" name="med-observations" rows="2" placeholder="Ej: Tomar con comida, evitar lácteos..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"></textarea>
                </div>
                <button type="submit" class="w-full md:col-start-3 md:w-auto bg-pastel-blue hover:bg-blue-300 text-blue-800 font-semibold px-6 py-2 rounded-md shadow hover:shadow-md transition duration-150 ease-in-out justify-self-end mt-2">
                    <i class="fas fa-plus mr-2"></i>Añadir
                </button>
            </form>
        </section>

        <section>
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Mis Medicamentos</h2>
                <button id="print-button" title="Imprimir Lista" class="text-gray-600 hover:text-blue-600 p-2 rounded-md hover:bg-gray-100 transition duration-150 ease-in-out">
                    <i class="fas fa-print fa-lg"></i>
                </button>
            </div>
            <div id="med-list" class="space-y-4">
                <p id="no-meds-message" class="text-gray-500 text-center py-4">Aún no has añadido ningún medicamento.</p>
            </div>
        </section>

    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Editar Medicamento</h3>
            <form id="edit-med-form">
                <input type="hidden" id="edit-med-id">
                <div class="mb-4">
                    <label for="edit-med-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="edit-med-name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div class="mb-4">
                    <label for="edit-med-dosage" class="block text-sm font-medium text-gray-600 mb-1">Dosis</label>
                    <input type="text" id="edit-med-dosage" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div class="mb-4">
                    <label for="edit-med-take-group" class="block text-sm font-medium text-gray-600 mb-1">Grupo de Tomas</label>
                    <input type="text" id="edit-med-take-group" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div class="mb-4">
                    <label for="edit-med-schedule" class="block text-sm font-medium text-gray-600 mb-1">Horario(s) Específico(s)</label>
                    <input type="text" id="edit-med-schedule" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div class="mb-4">
                    <label for="edit-med-priority" class="block text-sm font-medium text-gray-600 mb-1">Prioridad</label>
                    <select id="edit-med-priority" name="edit-med-priority" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out bg-white">
                        <option value="alta">Alta</option>
                        <option value="media">Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                 <div class="mb-4">
                     <label for="edit-med-observations" class="block text-sm font-medium text-gray-600 mb-1">Observaciones</label>
                     <textarea id="edit-med-observations" name="edit-med-observations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                     <button type="button" onclick="closeEditModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-md transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-pastel-green hover:bg-green-300 text-green-800 font-semibold px-4 py-2 rounded-md shadow hover:shadow-md transition duration-150 ease-in-out">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Constantes y Variables Globales ---
        const addMedForm = document.getElementById('add-med-form');
        const medListContainer = document.getElementById('med-list');
        const noMedsMessage = document.getElementById('no-meds-message');
        const editModal = document.getElementById('edit-modal');
        const editMedForm = document.getElementById('edit-med-form');
        const editMedIdInput = document.getElementById('edit-med-id');
        const editMedNameInput = document.getElementById('edit-med-name');
        const editMedDosageInput = document.getElementById('edit-med-dosage');
        const editMedTakeGroupInput = document.getElementById('edit-med-take-group');
        const editMedScheduleInput = document.getElementById('edit-med-schedule');
        const editMedPriorityInput = document.getElementById('edit-med-priority');
        const editMedObservationsInput = document.getElementById('edit-med-observations');
        const printButton = document.getElementById('print-button'); // Cambiado ID

        const daysOfWeek = ['L', 'M', 'X', 'J', 'V', 'S', 'D']; // Lunes a Domingo

        // --- Cargar Medicamentos del Local Storage ---
        let medications = JSON.parse(localStorage.getItem('medications')) || [];

        // --- Funciones ---

        /**
         * Guarda la lista actual de medicamentos en Local Storage.
         */
        function saveMedications() {
            localStorage.setItem('medications', JSON.stringify(medications));
        }

        /**
         * Obtiene la clase CSS y el texto para una etiqueta de prioridad.
         * @param {string} priority - La prioridad ('alta', 'media', 'baja').
         * @returns {object} - Objeto con 'className' y 'text'.
         */
        function getPriorityBadge(priority) {
            switch (priority) {
                case 'alta':
                    return { className: 'priority-alta', text: 'Alta' };
                case 'media':
                    return { className: 'priority-media', text: 'Media' };
                case 'baja':
                    return { className: 'priority-baja', text: 'Baja' };
                default:
                    return { className: 'priority-media', text: 'Media' };
            }
        }


        /**
         * Renderiza la lista de medicamentos en el HTML, agrupados por Grupo de Tomas y ordenados.
         */
        function renderMedications() {
            medListContainer.innerHTML = ''; // Limpiar contenedor

            if (medications.length === 0) {
                medListContainer.appendChild(noMedsMessage);
                noMedsMessage.style.display = 'block';
                printButton.style.display = 'none'; // Ocultar botón imprimir si no hay meds
            } else {
                noMedsMessage.style.display = 'none';
                printButton.style.display = 'inline-block'; // Mostrar botón imprimir

                // 1. Ordenar medicamentos: Primero por Grupo de Tomas, luego por Horario
                const sortedMeds = [...medications].sort((a, b) => {
                    const groupA = (a.takeGroup || 'ZZZ').trim().toLowerCase();
                    const groupB = (b.takeGroup || 'ZZZ').trim().toLowerCase();
                    if (groupA < groupB) return -1;
                    if (groupA > groupB) return 1;

                    const scheduleA = a.schedule.trim().toLowerCase();
                    const scheduleB = b.schedule.trim().toLowerCase();
                    if (scheduleA < scheduleB) return -1;
                    if (scheduleA > scheduleB) return 1;

                    const nameA = a.name.trim().toLowerCase();
                    const nameB = b.name.trim().toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;

                    return 0;
                });

                let currentTakeGroup = null;

                // 2. Iterar sobre la copia ordenada y renderizar, insertando encabezados de Grupo
                sortedMeds.forEach((med) => {
                    const takeGroupDisplay = med.takeGroup ? med.takeGroup.trim() : '';

                    if (takeGroupDisplay !== currentTakeGroup) {
                        const header = document.createElement('h3');
                        header.className = 'take-group-header';
                        header.textContent = `Grupo: ${takeGroupDisplay || 'Sin Grupo Asignado'}`;
                        medListContainer.appendChild(header);
                        currentTakeGroup = takeGroupDisplay;
                    }

                    const medElement = document.createElement('div');
                    medElement.className = 'bg-white p-4 rounded-lg shadow flex flex-col md:flex-row items-start md:items-center justify-between gap-4 transition-shadow hover:shadow-md';
                    medElement.dataset.id = med.id;

                    // --- Contenido de la tarjeta ---
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'flex-grow mb-4 md:mb-0 mr-4';
                    const priorityInfo = getPriorityBadge(med.priority);
                    const dosageText = med.dosage ? `<p class="text-sm text-gray-600">Dosis: ${med.dosage}</p>` : '';
                    const observationsText = med.observations ? `<p class="observations-text">Obs: ${med.observations}</p>` : '';
                    infoDiv.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-800 inline">${med.name}</h4>
                        <span class="priority-badge ${priorityInfo.className}">${priorityInfo.text}</span>
                        ${dosageText}
                        <p class="text-sm text-gray-500 mt-1">Horario: ${med.schedule}</p>
                        ${observationsText}
                    `;

                    const daysDiv = document.createElement('div');
                    daysDiv.className = 'flex items-center justify-center flex-wrap gap-2';
                    daysOfWeek.forEach((day, dayIndex) => {
                        const dayBubble = document.createElement('button');
                        dayBubble.className = `day-bubble w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-semibold text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-400 ${med.days[dayIndex] ? 'taken' : ''}`;
                        dayBubble.textContent = day;
                        dayBubble.title = `Marcar/Desmarcar ${day}`;
                        dayBubble.setAttribute('aria-label', `Marcar ${med.name} como tomado el día ${day}`);
                        dayBubble.setAttribute('role', 'checkbox');
                        dayBubble.setAttribute('aria-checked', med.days[dayIndex]);
                        dayBubble.addEventListener('click', () => {
                            toggleDayStatus(med.id, dayIndex);
                        });
                        daysDiv.appendChild(dayBubble);
                    });

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'actionsDiv flex gap-2 items-center ml-0 md:ml-4 flex-shrink-0'; // Añadida clase para ocultar en print
                    // --- Botones de Editar y Eliminar ---
                    const editButton = document.createElement('button');
                    editButton.className = 'text-blue-500 hover:text-blue-700 transition duration-150 p-1';
                    editButton.innerHTML = '<i class="fas fa-edit fa-lg"></i>';
                    editButton.title = 'Editar Medicamento';
                    editButton.onclick = () => openEditModal(med.id);
                    actionsDiv.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'text-red-500 hover:text-red-700 transition duration-150 p-1';
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt fa-lg"></i>';
                    deleteButton.title = 'Eliminar Medicamento';
                    deleteButton.onclick = () => deleteMedication(med.id);
                    actionsDiv.appendChild(deleteButton);

                    medElement.appendChild(infoDiv);
                    medElement.appendChild(daysDiv);
                    medElement.appendChild(actionsDiv);

                    medListContainer.appendChild(medElement);
                });
            }
        }

        /**
         * Añade un nuevo medicamento a la lista.
         * @param {Event} event - El evento de envío del formulario.
         */
        function addMedication(event) {
            event.preventDefault();
            const medNameInput = document.getElementById('med-name');
            const medDosageInput = document.getElementById('med-dosage');
            const medTakeGroupInput = document.getElementById('med-take-group');
            const medScheduleInput = document.getElementById('med-schedule');
            const medPriorityInput = document.getElementById('med-priority');
            const medObservationsInput = document.getElementById('med-observations');

            const medName = medNameInput.value.trim();
            const medDosage = medDosageInput.value.trim();
            const medTakeGroup = medTakeGroupInput.value.trim();
            const medSchedule = medScheduleInput.value.trim();
            const medPriority = medPriorityInput.value;
            const medObservations = medObservationsInput.value.trim();

            if (medName && medSchedule) {
                const newMed = {
                    id: Date.now(),
                    name: medName,
                    dosage: medDosage,
                    takeGroup: medTakeGroup,
                    schedule: medSchedule,
                    priority: medPriority,
                    observations: medObservations,
                    days: Array(7).fill(false)
                };
                medications.push(newMed);
                saveMedications();
                renderMedications();
                addMedForm.reset();
                medNameInput.focus();
            } else {
                alert('Por favor, introduce al menos el nombre y el horario específico del medicamento.');
            }
        }

         /**
         * Elimina un medicamento de la lista.
         * @param {number} medId - El ID del medicamento a eliminar.
         */
        function deleteMedication(medId) {
            if (confirm('¿Estás seguro de que quieres eliminar este medicamento?')) {
                medications = medications.filter(med => med.id !== medId);
                saveMedications();
                renderMedications();
            }
        }

        /**
         * Cambia el estado (tomado/no tomado) de un día específico para un medicamento.
         * @param {number} medId - El ID del medicamento.
         * @param {number} dayIndex - El índice del día (0=Lunes, 6=Domingo).
         */
        function toggleDayStatus(medId, dayIndex) {
            const medIndex = medications.findIndex(med => med.id === medId);
            if (medIndex !== -1) {
                medications[medIndex].days[dayIndex] = !medications[medIndex].days[dayIndex];
                saveMedications();

                // Actualizar solo la burbuja visualmente
                const medElements = medListContainer.querySelectorAll(`[data-id='${medId}']`);
                 medElements.forEach(medElement => {
                    const dayButton = medElement.querySelectorAll('.day-bubble')[dayIndex];
                    if(dayButton) {
                         dayButton.classList.toggle('taken', medications[medIndex].days[dayIndex]);
                         dayButton.setAttribute('aria-checked', medications[medIndex].days[dayIndex]);
                    }
                 });
            }
        }

        /**
         * Abre el modal de edición y carga los datos del medicamento.
         * @param {number} medId - El ID del medicamento a editar.
         */
        function openEditModal(medId) {
            const medToEdit = medications.find(med => med.id === medId);
            if (medToEdit) {
                editMedIdInput.value = medToEdit.id;
                editMedNameInput.value = medToEdit.name;
                editMedDosageInput.value = medToEdit.dosage || '';
                editMedTakeGroupInput.value = medToEdit.takeGroup || '';
                editMedScheduleInput.value = medToEdit.schedule;
                editMedPriorityInput.value = medToEdit.priority || 'media';
                editMedObservationsInput.value = medToEdit.observations || '';
                editModal.style.display = 'flex';
            }
        }

        /**
         * Cierra el modal de edición.
         */
        function closeEditModal() {
            editModal.style.display = 'none';
            editMedForm.reset();
        }

         /**
         * Guarda los cambios realizados en el modal de edición.
         * @param {Event} event - El evento de envío del formulario de edición.
         */
        function saveEditedMedication(event) {
            event.preventDefault();
            const medId = parseInt(editMedIdInput.value);
            const newName = editMedNameInput.value.trim();
            const newDosage = editMedDosageInput.value.trim();
            const newTakeGroup = editMedTakeGroupInput.value.trim();
            const newSchedule = editMedScheduleInput.value.trim();
            const newPriority = editMedPriorityInput.value;
            const newObservations = editMedObservationsInput.value.trim();

            if (medId && newName && newSchedule) {
                const medIndex = medications.findIndex(med => med.id === medId);
                if (medIndex !== -1) {
                    medications[medIndex].name = newName;
                    medications[medIndex].dosage = newDosage;
                    medications[medIndex].takeGroup = newTakeGroup;
                    medications[medIndex].schedule = newSchedule;
                    medications[medIndex].priority = newPriority;
                    medications[medIndex].observations = newObservations;
                    saveMedications();
                    renderMedications();
                    closeEditModal();
                }
            } else {
                 alert('Por favor, completa al menos el nombre y el horario específico para editar.');
            }
        }

        // --- Función exportToPdf eliminada ---

        // --- Event Listeners ---
        addMedForm.addEventListener('submit', addMedication);
        editMedForm.addEventListener('submit', saveEditedMedication);
        // Listener para el botón de imprimir
        printButton.addEventListener('click', () => {
            window.print(); // Llama a la función de impresión del navegador
        });

        // Cerrar modal si se hace clic fuera de él
        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
        }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', renderMedications);

    </script>

</body>
</html>
