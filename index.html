<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pastillero Semanal Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Colores pastel para botones y elementos específicos */
        .bg-pastel-blue { background-color: #a7c7e7; }
        .bg-pastel-green { background-color: #98d8c2; }
        .bg-pastel-pink { background-color: #f8c8dc; }
        .bg-pastel-yellow { background-color: #fdfd96; }
        .text-pastel-blue { color: #a7c7e7; }
        .text-pastel-green { color: #98d8c2; }
        .text-pastel-pink { color: #f8c8dc; }
        .text-pastel-yellow { color: #fdfd96; }

        /* Botones de acción pequeños */
        .action-button {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.15s ease-in-out;
        }
         .action-button:hover {
             box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
         }

        /* Burbujas de días */
        .day-bubble {
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #d1d5db; /* Borde ligero para definición */
        }
        .day-bubble.taken {
            background-color: #6ee7b7; /* Verde menta */
            color: #047857; /* Verde oscuro */
            transform: scale(1.05);
            border-color: #059669; /* Borde más oscuro al marcar */
        }
        .day-bubble:not(.taken) {
            background-color: #e5e7eb; /* Gris claro */
            color: #4b5563; /* Gris oscuro */
        }
        /* Estilos del modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        /* Estilo para botones deshabilitados */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Estilos para etiquetas de prioridad */
        .priority-badge {
            font-size: 0.75rem; /* 12px */
            padding: 0.125rem 0.5rem; /* py-0.5 px-2 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 600; /* font-semibold */
            margin-left: 0.5rem; /* ml-2 */
            vertical-align: middle; /* Alinear con el texto */
        }
        .priority-alta { background-color: #fecaca; color: #991b1b; } /* bg-red-200 text-red-800 */
        .priority-media { background-color: #fef08a; color: #854d0e; } /* bg-yellow-200 text-yellow-800 */
        .priority-baja { background-color: #a7f3d0; color: #065f46; } /* bg-green-200 text-green-800 */

        /* Estilo para observaciones */
        .observations-text {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
            margin-top: 0.25rem; /* mt-1 */
            font-style: italic;
        }
        /* Estilo para encabezados de Grupo de Tomas */
        .take-group-header {
            background-color: #dbeafe; /* bg-blue-100 */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            margin-top: 1.5rem; /* my-6 -> solo margen superior */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #1e3a8a; /* text-blue-800 */
        }
        /* Estilo para sección nombre paciente */
        #patient-section {
            margin-bottom: 1.5rem; /* mb-6 */
            padding: 1rem; /* p-4 */
            background-color: #f9fafb; /* bg-gray-50 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
        }
        #display-patient-name {
            font-weight: 600; /* font-semibold */
            color: #1d4ed8; /* text-blue-700 */
        }

        /* --- ESTILOS PARA IMPRESIÓN --- */
        @media print {
            body {
                background: none !important;
                padding: 0;
                margin: 1cm;
                font-family: sans-serif;
                color: #000 !important;
            }
            /* Ocultar elementos no deseados */
            header > p, /* Ocultar subtítulo del header */
            #patient-input-container, /* Ocultar input y botón guardar nombre */
            section.mb-8, /* Formulario Añadir Med */
            #print-button,
            #reset-week-button,
            #import-csv-button,
            #export-csv-button,
            .modal,
            .actionsDiv
             {
                display: none !important;
            }
             /* Mostrar y estilizar nombre de paciente */
            #patient-section {
                background: none !important;
                border: none !important;
                padding: 0 0 0.5cm 0 !important; /* Espacio debajo */
                margin-bottom: 0.5cm !important;
                text-align: left;
            }
             #display-patient-name-container {
                 font-size: 14pt;
                 font-weight: bold;
                 color: #000 !important;
             }
             #display-patient-name {
                 font-weight: bold;
                 color: #000 !important;
             }

            /* Ajustar contenedor principal */
            .container {
                box-shadow: none !important;
                border: none !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                background: none !important;
            }
            /* Estilo de encabezados de grupo para impresión */
            .take-group-header {
                background-color: #eee !important;
                color: #000 !important;
                margin-top: 1rem;
                padding: 0.25rem 0.5rem;
                border: 1px solid #ccc;
                page-break-before: auto;
                page-break-after: avoid;
            }
            /* Estilo de tarjetas de medicamento para impresión */
            #med-list > div:not(#no-meds-message) {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
                page-break-inside: avoid;
                background: #fff !important;
            }
             /* Estilo de burbujas de día para impresión */
            .day-bubble {
                border: 1px solid #999 !important;
                width: 1.5rem !important;
                height: 1.5rem !important;
                font-size: 0.7rem !important;
                line-height: 1.4rem !important;
                margin: 1px !important;
                padding: 0 !important;
            }
            .day-bubble.taken {
                background-color: #ccc !important;
                color: #000 !important;
                border-color: #666 !important;
                transform: none !important;
            }
            .day-bubble:not(.taken) {
                background-color: #fff !important;
                color: #333 !important;
            }
             /* Simplificar etiquetas de prioridad */
            .priority-badge {
                border: 1px solid #555;
                padding: 0 0.3rem;
                margin-left: 0.3rem;
                background-color: #fff !important;
                font-size: 0.7rem;
            }
            .priority-alta { border-color: #000; color: #000 !important; font-weight: bold;}
            .priority-media { border-color: #555; color: #000 !important; }
            .priority-baja { border-color: #999; color: #333 !important; }

            /* Asegurar texto negro en elementos generales */
            h1, h2, h3, h4, p, span, div, label, input, select, textarea {
               color: #000 !important;
            }
            input::placeholder, textarea::placeholder {
                color: transparent !important;
            }
        }

    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-100 via-pink-50 to-yellow-50 min-h-screen p-4 md:p-8">

    <div class="container mx-auto max-w-4xl bg-white rounded-xl shadow-lg p-6 md:p-8">

        <header class="text-center mb-4"> <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Pastillero Semanal Virtual</h1>
            </header>

        <section id="patient-section">
             <div id="display-patient-name-container" class="mb-2 text-lg">
                 Mostrando pastillero de: <span id="display-patient-name"></span>
             </div>
             <div id="patient-input-container" class="flex items-end flex-wrap gap-2">
                 <label for="patient-name-input" class="text-sm font-medium text-gray-600 mb-1">Editar Nombre Paciente:</label> <input type="text" id="patient-name-input" placeholder="Escribe el nombre aquí" class="flex-grow px-3 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out text-sm">
                 <button id="save-patient-name-button" class="action-button bg-green-100 hover:bg-green-200 text-green-800 mt-1 md:mt-0"> <i class="fas fa-save mr-1"></i> Guardar Nombre
                 </button>
             </div>
        </section>

        <section class="mb-8 p-6 bg-blue-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Añadir Nuevo Medicamento</h2>
            <form id="add-med-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                <div>
                    <label for="med-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="med-name" name="med-name" required placeholder="Ej: Ibuprofeno" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div>
                    <label for="med-dosage" class="block text-sm font-medium text-gray-600 mb-1">Dosis</label>
                    <input type="text" id="med-dosage" name="med-dosage" placeholder="Ej: 400mg, 1 comp." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="med-take-group" class="block text-sm font-medium text-gray-600 mb-1">Grupo de Tomas</label>
                    <input type="text" id="med-take-group" name="med-take-group" placeholder="Ej: A, B, Mañana..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="med-schedule" class="block text-sm font-medium text-gray-600 mb-1">Horario(s) Específico(s)</label>
                    <input type="text" id="med-schedule" name="med-schedule" required placeholder="Ej: 8:00 AM, 9:00 PM" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div>
                    <label for="med-priority" class="block text-sm font-medium text-gray-600 mb-1">Prioridad</label>
                    <select id="med-priority" name="med-priority" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out bg-white">
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                <div class="md:col-span-3">
                     <label for="med-observations" class="block text-sm font-medium text-gray-600 mb-1">Observaciones</label>
                     <textarea id="med-observations" name="med-observations" rows="2" placeholder="Ej: Tomar con comida, evitar lácteos..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"></textarea>
                </div>
                <button type="submit" class="w-full md:col-start-3 md:w-auto bg-pastel-blue hover:bg-blue-300 text-blue-800 font-semibold px-6 py-2 rounded-md shadow hover:shadow-md transition duration-150 ease-in-out justify-self-end mt-2">
                    <i class="fas fa-plus mr-2"></i>Añadir
                </button>
            </form>
        </section>

        <section>
             <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <h2 class="text-xl font-semibold text-gray-700">Medicamentos</h2> <div class="flex gap-2 items-center">
                    <button id="reset-week-button" title="Reiniciar Semana" class="action-button bg-yellow-100 hover:bg-yellow-200 text-yellow-800">
                        <i class="fas fa-undo mr-1"></i> Reiniciar Semana
                    </button>
                    <button id="import-csv-button" title="Importar Lista desde CSV" class="action-button bg-green-100 hover:bg-green-200 text-green-800">
                        <i class="fas fa-file-upload mr-1"></i> Importar CSV
                    </button>
                     <button id="export-csv-button" title="Exportar Lista a CSV" class="action-button bg-blue-100 hover:bg-blue-200 text-blue-800">
                        <i class="fas fa-file-download mr-1"></i> Exportar CSV
                    </button>
                    <button id="print-button" title="Imprimir Lista" class="text-gray-600 hover:text-blue-600 p-2 rounded-md hover:bg-gray-100 transition duration-150 ease-in-out">
                        <i class="fas fa-print fa-lg"></i>
                    </button>
                     <input type="file" id="csv-import-input" accept=".csv" style="display: none;">
                </div>
            </div>
            <div id="med-list" class="space-y-4">
                <p id="no-meds-message" class="text-gray-500 text-center py-4">Aún no has añadido ningún medicamento.</p>
            </div>
        </section>

    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Editar Medicamento</h3>
            <form id="edit-med-form">
                <input type="hidden" id="edit-med-id">
                <div class="mb-4">
                    <label for="edit-med-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="edit-med-name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div class="mb-4">
                    <label for="edit-med-dosage" class="block text-sm font-medium text-gray-600 mb-1">Dosis</label>
                    <input type="text" id="edit-med-dosage" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                 <div class="mb-4">
                    <label for="edit-med-take-group" class="block text-sm font-medium text-gray-600 mb-1">Grupo de Tomas</label>
                    <input type="text" id="edit-med-take-group" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div class="mb-4">
                    <label for="edit-med-schedule" class="block text-sm font-medium text-gray-600 mb-1">Horario(s) Específico(s)</label>
                    <input type="text" id="edit-med-schedule" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out">
                </div>
                <div class="mb-4">
                    <label for="edit-med-priority" class="block text-sm font-medium text-gray-600 mb-1">Prioridad</label>
                    <select id="edit-med-priority" name="edit-med-priority" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out bg-white">
                        <option value="alta">Alta</option>
                        <option value="media">Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                 <div class="mb-4">
                     <label for="edit-med-observations" class="block text-sm font-medium text-gray-600 mb-1">Observaciones</label>
                     <textarea id="edit-med-observations" name="edit-med-observations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-300 focus:border-blue-300 transition duration-150 ease-in-out"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                     <button type="button" onclick="closeEditModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-md transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-pastel-green hover:bg-green-300 text-green-800 font-semibold px-4 py-2 rounded-md shadow hover:shadow-md transition duration-150 ease-in-out">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Constantes y Variables Globales ---
        const addMedForm = document.getElementById('add-med-form');
        const medListContainer = document.getElementById('med-list');
        const noMedsMessage = document.getElementById('no-meds-message');
        const editModal = document.getElementById('edit-modal');
        const editMedForm = document.getElementById('edit-med-form');
        const editMedIdInput = document.getElementById('edit-med-id');
        const editMedNameInput = document.getElementById('edit-med-name');
        const editMedDosageInput = document.getElementById('edit-med-dosage');
        const editMedTakeGroupInput = document.getElementById('edit-med-take-group');
        const editMedScheduleInput = document.getElementById('edit-med-schedule');
        const editMedPriorityInput = document.getElementById('edit-med-priority');
        const editMedObservationsInput = document.getElementById('edit-med-observations');
        const printButton = document.getElementById('print-button');
        const resetWeekButton = document.getElementById('reset-week-button');
        const importCsvButton = document.getElementById('import-csv-button');
        const exportCsvButton = document.getElementById('export-csv-button');
        const csvImportInput = document.getElementById('csv-import-input');
        // Elementos para Nombre de Paciente
        const patientNameInput = document.getElementById('patient-name-input');
        const savePatientNameButton = document.getElementById('save-patient-name-button');
        const displayPatientName = document.getElementById('display-patient-name');


        const daysOfWeek = ['L', 'M', 'X', 'J', 'V', 'S', 'D']; // Lunes a Domingo

        // --- Cargar Datos del Local Storage ---
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let currentPatientName = localStorage.getItem('currentPatientName') || 'Mi Pastillero'; // Nombre por defecto

        // --- Funciones ---

        /**
         * Guarda la lista actual de medicamentos en Local Storage.
         */
        function saveMedications() {
            localStorage.setItem('medications', JSON.stringify(medications));
        }

         /**
          * Guarda el nombre del paciente actual en Local Storage.
          */
         function savePatientName() {
             const newName = patientNameInput.value.trim();
             if (newName) {
                 currentPatientName = newName;
                 localStorage.setItem('currentPatientName', currentPatientName);
                 displayPatientName.textContent = currentPatientName; // Actualizar display
                 patientNameInput.value = currentPatientName; // Sincronizar input
                 // Opcional: Mostrar mensaje de éxito brevemente
                 // alert('Nombre del paciente guardado.');
             } else {
                 alert('Por favor, introduce un nombre para el paciente.');
             }
         }

        /**
         * Obtiene la clase CSS y el texto para una etiqueta de prioridad.
         * @param {string} priority - La prioridad ('alta', 'media', 'baja').
         * @returns {object} - Objeto con 'className' y 'text'.
         */
        function getPriorityBadge(priority) {
            switch (priority) {
                case 'alta':
                    return { className: 'priority-alta', text: 'Alta' };
                case 'media':
                    return { className: 'priority-media', text: 'Media' };
                case 'baja':
                    return { className: 'priority-baja', text: 'Baja' };
                default:
                    return { className: 'priority-media', text: 'Media' };
            }
        }


        /**
         * Renderiza la lista de medicamentos en el HTML, agrupados por Grupo de Tomas y ordenados.
         */
        function renderMedications() {
            medListContainer.innerHTML = ''; // Limpiar contenedor

            const hasMedications = medications.length > 0;

            // Mover el mensaje de "no meds" fuera del contenedor principal antes de limpiarlo si existe
            if (noMedsMessage.parentNode === medListContainer) {
                 medListContainer.removeChild(noMedsMessage);
            }

            if (!hasMedications) {
                medListContainer.appendChild(noMedsMessage); // Añadirlo de nuevo si no hay meds
                noMedsMessage.style.display = 'block';
            } else {
                 noMedsMessage.style.display = 'none';
            }
             // Mostrar/ocultar botones de acción según si hay medicamentos
            printButton.style.display = hasMedications ? 'inline-block' : 'none';
            resetWeekButton.style.display = hasMedications ? 'inline-block' : 'none';
            exportCsvButton.style.display = hasMedications ? 'inline-block' : 'none';
            importCsvButton.style.display = 'inline-block';


            if (hasMedications) {
                // 1. Ordenar medicamentos: Primero por Grupo de Tomas, luego por Horario
                const sortedMeds = [...medications].sort((a, b) => {
                    const groupA = (a.takeGroup || 'ZZZ').trim().toLowerCase();
                    const groupB = (b.takeGroup || 'ZZZ').trim().toLowerCase();
                    if (groupA < groupB) return -1;
                    if (groupA > groupB) return 1;

                    const scheduleA = a.schedule.trim().toLowerCase();
                    const scheduleB = b.schedule.trim().toLowerCase();
                    if (scheduleA < scheduleB) return -1;
                    if (scheduleA > scheduleB) return 1;

                    const nameA = a.name.trim().toLowerCase();
                    const nameB = b.name.trim().toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;

                    return 0;
                });

                let currentTakeGroup = null;

                // 2. Iterar sobre la copia ordenada y renderizar, insertando encabezados de Grupo
                sortedMeds.forEach((med) => {
                    const takeGroupDisplay = med.takeGroup ? med.takeGroup.trim() : '';

                    if (takeGroupDisplay !== currentTakeGroup) {
                        const header = document.createElement('h3');
                        header.className = 'take-group-header';
                        header.textContent = `Grupo: ${takeGroupDisplay || 'Sin Grupo Asignado'}`;
                        medListContainer.appendChild(header);
                        currentTakeGroup = takeGroupDisplay;
                    }

                    const medElement = document.createElement('div');
                    medElement.className = 'bg-white p-4 rounded-lg shadow flex flex-col md:flex-row items-start md:items-center justify-between gap-4 transition-shadow hover:shadow-md';
                    medElement.dataset.id = med.id;

                    // --- Contenido de la tarjeta ---
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'flex-grow mb-4 md:mb-0 mr-4';
                    const priorityInfo = getPriorityBadge(med.priority);
                    const dosageText = med.dosage ? `<p class="text-sm text-gray-600">Dosis: ${med.dosage}</p>` : '';
                    const observationsText = med.observations ? `<p class="observations-text">Obs: ${med.observations}</p>` : '';
                    infoDiv.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-800 inline">${med.name}</h4>
                        <span class="priority-badge ${priorityInfo.className}">${priorityInfo.text}</span>
                        ${dosageText}
                        <p class="text-sm text-gray-500 mt-1">Horario: ${med.schedule}</p>
                        ${observationsText}
                    `;

                    const daysDiv = document.createElement('div');
                    daysDiv.className = 'flex items-center justify-center flex-wrap gap-2';
                    daysOfWeek.forEach((day, dayIndex) => {
                        const dayBubble = document.createElement('button');
                        dayBubble.className = `day-bubble w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-semibold text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-400 ${med.days[dayIndex] ? 'taken' : ''}`;
                        dayBubble.textContent = day;
                        dayBubble.title = `Marcar/Desmarcar ${day}`;
                        dayBubble.setAttribute('aria-label', `Marcar ${med.name} como tomado el día ${day}`);
                        dayBubble.setAttribute('role', 'checkbox');
                        dayBubble.setAttribute('aria-checked', med.days[dayIndex]);
                        dayBubble.addEventListener('click', () => {
                            toggleDayStatus(med.id, dayIndex);
                        });
                        daysDiv.appendChild(dayBubble);
                    });

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'actionsDiv flex gap-2 items-center ml-0 md:ml-4 flex-shrink-0'; // Clase para ocultar en print
                    // --- Botones de Editar y Eliminar ---
                    const editButton = document.createElement('button');
                    editButton.className = 'text-blue-500 hover:text-blue-700 transition duration-150 p-1';
                    editButton.innerHTML = '<i class="fas fa-edit fa-lg"></i>';
                    editButton.title = 'Editar Medicamento';
                    editButton.onclick = () => openEditModal(med.id);
                    actionsDiv.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'text-red-500 hover:text-red-700 transition duration-150 p-1';
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt fa-lg"></i>';
                    deleteButton.title = 'Eliminar Medicamento';
                    deleteButton.onclick = () => deleteMedication(med.id);
                    actionsDiv.appendChild(deleteButton);

                    medElement.appendChild(infoDiv);
                    medElement.appendChild(daysDiv);
                    medElement.appendChild(actionsDiv);

                    medListContainer.appendChild(medElement);
                });
            }
        }

        /**
         * Añade un nuevo medicamento a la lista.
         * @param {Event} event - El evento de envío del formulario.
         */
        function addMedication(event) {
            event.preventDefault();
            const medNameInput = document.getElementById('med-name');
            const medDosageInput = document.getElementById('med-dosage');
            const medTakeGroupInput = document.getElementById('med-take-group');
            const medScheduleInput = document.getElementById('med-schedule');
            const medPriorityInput = document.getElementById('med-priority');
            const medObservationsInput = document.getElementById('med-observations');

            const medName = medNameInput.value.trim();
            const medDosage = medDosageInput.value.trim();
            const medTakeGroup = medTakeGroupInput.value.trim();
            const medSchedule = medScheduleInput.value.trim();
            const medPriority = medPriorityInput.value;
            const medObservations = medObservationsInput.value.trim();

            if (medName && medSchedule) {
                const newMed = {
                    id: Date.now(),
                    name: medName,
                    dosage: medDosage,
                    takeGroup: medTakeGroup,
                    schedule: medSchedule,
                    priority: medPriority,
                    observations: medObservations,
                    days: Array(7).fill(false)
                };
                medications.push(newMed);
                saveMedications();
                renderMedications();
                addMedForm.reset();
                medNameInput.focus();
            } else {
                alert('Por favor, introduce al menos el nombre y el horario específico del medicamento.');
            }
        }

         /**
         * Elimina un medicamento de la lista.
         * @param {number} medId - El ID del medicamento a eliminar.
         */
        function deleteMedication(medId) {
            if (confirm('¿Estás seguro de que quieres eliminar este medicamento?')) {
                medications = medications.filter(med => med.id !== medId);
                saveMedications();
                renderMedications();
            }
        }

        /**
         * Cambia el estado (tomado/no tomado) de un día específico para un medicamento.
         * @param {number} medId - El ID del medicamento.
         * @param {number} dayIndex - El índice del día (0=Lunes, 6=Domingo).
         */
        function toggleDayStatus(medId, dayIndex) {
            const medIndex = medications.findIndex(med => med.id === medId);
            if (medIndex !== -1) {
                medications[medIndex].days[dayIndex] = !medications[medIndex].days[dayIndex];
                saveMedications();

                // Actualizar solo la burbuja visualmente
                const medElements = medListContainer.querySelectorAll(`[data-id='${medId}']`);
                 medElements.forEach(medElement => {
                    const dayButton = medElement.querySelectorAll('.day-bubble')[dayIndex];
                    if(dayButton) {
                         dayButton.classList.toggle('taken', medications[medIndex].days[dayIndex]);
                         dayButton.setAttribute('aria-checked', medications[medIndex].days[dayIndex]);
                    }
                 });
            }
        }

        /**
         * Abre el modal de edición y carga los datos del medicamento.
         * @param {number} medId - El ID del medicamento a editar.
         */
        function openEditModal(medId) {
            const medToEdit = medications.find(med => med.id === medId);
            if (medToEdit) {
                editMedIdInput.value = medToEdit.id;
                editMedNameInput.value = medToEdit.name;
                editMedDosageInput.value = medToEdit.dosage || '';
                editMedTakeGroupInput.value = medToEdit.takeGroup || '';
                editMedScheduleInput.value = medToEdit.schedule;
                editMedPriorityInput.value = medToEdit.priority || 'media';
                editMedObservationsInput.value = medToEdit.observations || '';
                editModal.style.display = 'flex';
            }
        }

        /**
         * Cierra el modal de edición.
         */
        function closeEditModal() {
            editModal.style.display = 'none';
            editMedForm.reset();
        }

         /**
         * Guarda los cambios realizados en el modal de edición.
         * @param {Event} event - El evento de envío del formulario de edición.
         */
        function saveEditedMedication(event) {
            event.preventDefault();
            const medId = parseInt(editMedIdInput.value);
            const newName = editMedNameInput.value.trim();
            const newDosage = editMedDosageInput.value.trim();
            const newTakeGroup = editMedTakeGroupInput.value.trim();
            const newSchedule = editMedScheduleInput.value.trim();
            const newPriority = editMedPriorityInput.value;
            const newObservations = editMedObservationsInput.value.trim();

            if (medId && newName && newSchedule) {
                const medIndex = medications.findIndex(med => med.id === medId);
                if (medIndex !== -1) {
                    medications[medIndex].name = newName;
                    medications[medIndex].dosage = newDosage;
                    medications[medIndex].takeGroup = newTakeGroup;
                    medications[medIndex].schedule = newSchedule;
                    medications[medIndex].priority = newPriority;
                    medications[medIndex].observations = newObservations;
                    saveMedications();
                    renderMedications();
                    closeEditModal();
                }
            } else {
                 alert('Por favor, completa al menos el nombre y el horario específico para editar.');
            }
        }

        /**
         * Reinicia las marcas de todos los días para todos los medicamentos.
         */
        function resetWeekMarks() {
            console.log("Reiniciar Semana: Botón pulsado.");
            if (confirm('¿Estás seguro de que quieres borrar todas las marcas de la semana?')) {
                console.log("Reiniciar Semana: Confirmación aceptada.");
                let changesMade = false;
                medications.forEach(med => {
                    if (med.days.some(dayTaken => dayTaken === true)) {
                        med.days = Array(7).fill(false);
                        changesMade = true;
                    }
                });

                if (changesMade) {
                    saveMedications();
                    renderMedications();
                    alert('Marcas de la semana reiniciadas.');
                    console.log("Reiniciar Semana: Marcas reiniciadas y guardadas.");
                } else {
                    alert('No había ninguna marca para reiniciar.');
                    console.log("Reiniciar Semana: No se hicieron cambios.");
                }
            } else {
                 console.log("Reiniciar Semana: Confirmación cancelada.");
            }
        }

        /**
         * Escapa un valor para usarlo en un CSV.
         * @param {*} value - El valor a escapar.
         * @returns {string} - El valor escapado para CSV.
         */
        function escapeCsvValue(value) {
            const stringValue = String(value || '');
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                const escapedValue = stringValue.replace(/"/g, '""');
                return `"${escapedValue}"`;
            }
            return stringValue;
        }

        /**
         * Exporta la lista actual de medicamentos a un archivo CSV, incluyendo el nombre del paciente.
         */
        function exportToCsv() {
            console.log("Exportar CSV: Iniciando...");
            if (medications.length === 0) {
                alert("No hay medicamentos para exportar.");
                console.log("Exportar CSV: No hay medicamentos.");
                return;
            }

            try {
                const headers = [
                    "Nombre", "Dosis", "Grupo de Tomas", "Horario",
                    "Prioridad", "Observaciones"
                ];

                const rows = medications.map(med => [
                    escapeCsvValue(med.name),
                    escapeCsvValue(med.dosage),
                    escapeCsvValue(med.takeGroup),
                    escapeCsvValue(med.schedule),
                    escapeCsvValue(med.priority),
                    escapeCsvValue(med.observations)
                ].join(','));

                // Añadir línea con el nombre del paciente (como comentario CSV)
                const patientLine = `# Paciente: ${currentPatientName || 'No especificado'}`;
                const csvContent = [patientLine, headers.join(','), ...rows].join('\n');
                console.log("Exportar CSV: Contenido CSV generado.");

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                console.log("Exportar CSV: Blob creado.");

                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    // Crear nombre de archivo seguro
                    const safePatientName = (currentPatientName || 'paciente').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    const filename = `medicamentos_${safePatientName}.csv`;

                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    console.log(`Exportar CSV: Descargando archivo: ${filename}`);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    console.warn("Exportar CSV: Descarga directa no soportada.");
                    alert("La descarga directa no es soportada por tu navegador.");
                }
             } catch (error) {
                 console.error("Exportar CSV: Error durante la exportación:", error);
                 alert("Ocurrió un error al intentar exportar a CSV.");
             }
        }

        /**
         * Maneja la selección de un archivo CSV para importar.
         * @param {Event} event - El evento 'change' del input file.
         */
        function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert("Por favor, selecciona un archivo con formato .csv");
                event.target.value = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvContent = e.target.result;
                // Extraer nombre del paciente si está en la primera línea como comentario
                let potentialPatientName = '';
                const firstLine = csvContent.split('\n')[0];
                if (firstLine.startsWith('# Paciente:')) {
                    potentialPatientName = firstLine.substring('# Paciente:'.length).trim();
                }

                let confirmMessage = '¿Importar archivo CSV? Esto reemplazará tu lista actual de medicamentos.';
                if (potentialPatientName) {
                    confirmMessage += `\n\nEl archivo parece ser del paciente: ${potentialPatientName}.\n¿Quieres actualizar también el nombre del paciente actual?`;
                }


                if (confirm(confirmMessage)) {
                    try {
                        const importedMeds = parseCsvContent(csvContent); // Parsear todo el contenido
                        if (importedMeds.length > 0) {
                            medications = importedMeds; // Reemplazar lista
                            // Actualizar nombre del paciente si se encontró y el usuario aceptó implícitamente (o preguntar explícitamente)
                            if (potentialPatientName) {
                                currentPatientName = potentialPatientName;
                                localStorage.setItem('currentPatientName', currentPatientName);
                                displayPatientName.textContent = currentPatientName;
                                patientNameInput.value = currentPatientName;
                            }
                            saveMedications(); // Guardar nueva lista
                            renderMedications(); // Renderizar
                            alert(`Importación completada. Se importaron ${importedMeds.length} medicamentos.`);
                        } else {
                             alert("No se encontraron medicamentos válidos en el archivo CSV o el formato no es correcto.");
                        }
                    } catch (error) {
                        console.error("Error al procesar el archivo CSV:", error);
                        alert(`Error al procesar el archivo CSV: ${error.message}`);
                    } finally {
                         event.target.value = null;
                    }
                } else {
                    event.target.value = null;
                }
            };
            reader.onerror = function(e) {
                console.error("Error al leer el archivo:", e);
                alert("Ocurrió un error al intentar leer el archivo.");
                 event.target.value = null;
            };
            reader.readAsText(file);
        }

        /**
         * Parsea el contenido de un archivo CSV.
         * @param {string} csvText - El contenido del archivo CSV.
         * @returns {Array<object>} - Un array de objetos de medicamento.
         */
        function parseCsvContent(csvText) {
            const lines = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim().split('\n');
            if (lines.length === 0) {
                 throw new Error("El archivo CSV está vacío.");
            }

            let headerLineIndex = 0;
            // Saltar líneas de comentario iniciales (ej. # Paciente:)
            while (lines[headerLineIndex] && lines[headerLineIndex].startsWith('#')) {
                headerLineIndex++;
            }

            if (headerLineIndex >= lines.length -1) { // No hay cabecera o no hay datos
                 throw new Error("El archivo CSV no contiene cabeceras o datos válidos.");
            }

            const headers = lines[headerLineIndex].split(',').map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));
            const importedMeds = [];

            // Mapeo de índices
             const nameIndex = headers.findIndex(h => h.includes("nombre"));
            const dosageIndex = headers.findIndex(h => h.includes("dosis"));
            const groupIndex = headers.findIndex(h => h.includes("grupo"));
            const scheduleIndex = headers.findIndex(h => h.includes("horario"));
            const priorityIndex = headers.findIndex(h => h.includes("prioridad"));
            const obsIndex = headers.findIndex(h => h.includes("observaciones"));

            if (nameIndex === -1 || scheduleIndex === -1) {
                 throw new Error("El archivo CSV debe contener al menos las columnas 'Nombre' y 'Horario'. Revisa las cabeceras.");
            }

            // Procesar líneas de datos
            for (let i = headerLineIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Parser simple
                const values = [];
                let currentVal = '';
                let inQuotes = false;
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    const nextChar = line[j+1];
                    if (char === '"' && !inQuotes && currentVal === '') { // Comilla al inicio del campo
                        inQuotes = true;
                    } else if (char === '"' && inQuotes && nextChar === '"') { // Comilla doble escapada
                         currentVal += '"';
                         j++;
                    } else if (char === '"' && inQuotes && (nextChar === ',' || nextChar === undefined)) { // Comilla al final del campo
                         inQuotes = false;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentVal);
                        currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
                 values.push(currentVal); // Añadir último valor

                 // Limpiar comillas envolventes si las hubiera (el parser anterior debería manejarlas)
                 // const cleanedValues = values.map(v => v.startsWith('"') && v.endsWith('"') ? v.slice(1, -1).replace(/""/g, '"') : v);
                 const cleanedValues = values; // Usar valores directamente del parser mejorado


                // Crear objeto medicamento
                const name = cleanedValues[nameIndex];
                const schedule = cleanedValues[scheduleIndex];

                if (name && schedule) {
                     const newMed = {
                        id: Date.now() + i,
                        name: name,
                        dosage: dosageIndex !== -1 ? cleanedValues[dosageIndex] : '',
                        takeGroup: groupIndex !== -1 ? cleanedValues[groupIndex] : '',
                        schedule: schedule,
                        priority: priorityIndex !== -1 ? (cleanedValues[priorityIndex] || 'media') : 'media',
                        observations: obsIndex !== -1 ? cleanedValues[obsIndex] : '',
                        days: Array(7).fill(false)
                    };
                    importedMeds.push(newMed);
                } else {
                    console.warn(`Línea ${i+1} ignorada por falta de Nombre u Horario: ${line}`);
                }
            }
            return importedMeds;
        }


        // --- Event Listeners ---
        addMedForm.addEventListener('submit', addMedication);
        editMedForm.addEventListener('submit', saveEditedMedication);
        printButton.addEventListener('click', () => { window.print(); });
        resetWeekButton.addEventListener('click', resetWeekMarks);
        exportCsvButton.addEventListener('click', exportToCsv);
        // Listener para guardar nombre paciente
        savePatientNameButton.addEventListener('click', savePatientName);
        // Listener para el botón de importar que activa el input oculto
        importCsvButton.addEventListener('click', () => {
            csvImportInput.value = null;
            csvImportInput.click();
        });
        // Listener para cuando se selecciona un archivo en el input oculto
        csvImportInput.addEventListener('change', handleCsvImport);


        // Cerrar modal si se hace clic fuera de él
        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
        }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar y mostrar nombre del paciente inicial
            patientNameInput.value = currentPatientName;
            displayPatientName.textContent = currentPatientName;
            // Renderizar medicamentos
            renderMedications();
        });

    </script>

</body>
</html>
